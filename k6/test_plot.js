import http from "k6/http";
import { check, sleep } from "k6";

export const options = {
  vus: 10,
  duration: '60s',
};

const headers = {
  Host: "kserve-custom-inference-service.default.example.com",
  "Content-Type": "application/json",
};

const modelName = "rf-crc-e2e";
const inferenceBaseURL = "http://127.0.0.1:8080";

const test_data = {
  dataframe_split: {
    columns: [
      "subject_id",
      "Parabacteroides_unclassified",
      "Atopobium_parvulum",
      "Ruminococcus_obeum",
      "Acidaminococcus_unclassified",
      "Ruminococcus_gnavus",
      "Megasphaera_unclassified",
      "Eubacterium_rectale",
      "Bacteroides_vulgatus",
      "Clostridium_hathewayi",
      "Odoribacter_laneus",
      "Peptostreptococcus_unclassified",
      "Faecalibacterium_prausnitzii",
      "Bacillus_subtilis",
      "Alistipes_shahii",
      "Ruminococcus_torques",
      "Clostridium_leptum",
      "Lachnospiraceae_bacterium_2_1_58FAA",
      "Streptococcus_constellatus",
      "Desulfovibrio_desulfuricans",
      "Bacteroides_ovatus",
      "Burkholderiales_bacterium_1_1_47",
      "Acidaminococcus_fermentans",
      "Granulicatella_unclassified",
      "Escherichia_unclassified",
      "Bifidobacterium_adolescentis",
      "Megasphaera_elsdenii",
      "Clostridium_innocuum",
      "Megasphaera_micronuciformis",
      "Eubacterium_ventriosum",
      "Holdemania_filiformis",
      "Turicibacter_sanguinis",
      "Lachnospiraceae_bacterium_9_1_43BFAA",
      "Parabacteroides_goldsteinii",
      "Dorea_formicigenerans",
      "Streptococcus_intermedius",
      "Turicibacter_unclassified",
      "Actinomyces_odontolyticus",
      "Alistipes_putredinis",
      "Parasutterella_excrementihominis",
      "Lachnospiraceae_bacterium_8_1_57FAA",
      "Lactobacillus_salivarius",
      "Granulicatella_adiacens",
      "Roseburia_inulinivorans",
      "Lachnospiraceae_bacterium_3_1_46FAA",
      "Rothia_dentocariosa",
      "Bifidobacterium_dentium",
      "Megamonas_hypermegale",
      "Adlercreutzia_equolifaciens",
      "Alistipes_indistinctus",
      "Bacteroides_cellulosilyticus",
      "Odoribacter_splanchnicus",
      "Eubacterium_ramulus",
      "Eubacterium_cylindroides",
      "Roseburia_hominis",
      "Bacteroides_uniformis",
      "Clostridium_clostridioforme",
      "Alistipes_unclassified",
      "Streptococcus_mutans",
      "Fusobacterium_nucleatum",
      "Oscillibacter_unclassified",
      "Pseudoflavonifractor_capillosus",
      "Clostridium_scindens",
      "Gemella_unclassified",
      "Eggerthella_lenta",
      "Clostridium_asparagiforme",
      "Bacteroides_nordii",
      "Eggerthella_unclassified",
      "Coprobacter_fastidiosus",
      "Paraprevotella_unclassified",
      "Lachnospiraceae_bacterium_1_1_57FAA",
      "Coprobacillus_unclassified",
      "Blautia_hydrogenotrophica",
      "Erysipelotrichaceae_bacterium_6_1_45",
      "Flavonifractor_plautii",
      "Alistipes_senegalensis",
      "Clostridiaceae_bacterium_JC118",
      "Ruminococcus_lactaris",
      "Bifidobacterium_pseudocatenulatum",
      "Barnesiella_intestinihominis",
      "Lachnospiraceae_bacterium_5_1_63FAA",
      "Ruminococcus_bromii",
      "Bacteroides_finegoldii",
      "Gemella_morbillorum",
      "Bacteroides_fragilis",
      "Ruminococcus_callidus",
      "Odoribacter_unclassified",
      "Lachnospiraceae_bacterium_5_1_57FAA",
      "Eubacterium_sp_3_1_31",
      "Megamonas_unclassified",
      "Ruminococcus_sp_5_1_39BFAA",
      "Parvimonas_unclassified",
      "Enterobacter_cloacae",
      "Bilophila_unclassified",
      "Streptococcus_vestibularis",
      "Haemophilus_parainfluenzae",
      "Acidaminococcus_intestini",
      "Fusobacterium_mortiferum",
      "Rothia_mucilaginosa",
      "Clostridium_symbiosum",
      "Lachnospiraceae_bacterium_7_1_58FAA",
      "Bifidobacterium_breve",
      "Klebsiella_pneumoniae",
      "Bacteroides_coprocola",
      "Streptococcus_parasanguinis",
      "Klebsiella_oxytoca",
      "Alistipes_finegoldii",
      "Parabacteroides_merdae",
      "Megamonas_funiformis",
      "Akkermansia_muciniphila",
      "Paraprevotella_xylaniphila",
      "Bacteroides_salyersiae",
      "Erysipelotrichaceae_bacterium_2_2_44A",
      "Parabacteroides_johnsonii",
      "Eubacterium_hallii",
      "Veillonella_dispar",
      "Eubacterium_siraeum",
      "Bacteroides_faecis",
      "Bacteroides_dorei",
      "Gemella_sanguinis",
      "Dorea_unclassified",
      "Collinsella_aerofaciens",
      "Roseburia_intestinalis",
      "Subdoligranulum_sp_4_3_54A2FAA",
      "Streptococcus_thermophilus",
      "Bacteroides_plebeius",
      "Bifidobacterium_bifidum",
      "Clostridium_bolteae",
      "Clostridium_nexile",
      "Lachnospiraceae_bacterium_3_1_57FAA_CT1",
      "Bifidobacterium_longum",
      "Megamonas_rupellensis",
      "Streptococcus_infantis",
      "Mitsuokella_multacida",
      "Clostridium_bartlettii",
      "Dialister_invisus",
      "Prevotella_stercorea",
      "Bacteroides_massiliensis",
      "Erysipelotrichaceae_bacterium_21_3",
      "Gemella_haemolysans",
      "Subdoligranulum_unclassified",
      "Streptococcus_salivarius",
      "Paraprevotella_clara",
      "Streptococcus_anginosus",
      "Bacteroides_xylanisolvens",
      "Eubacterium_eligens",
      "Veillonella_parvula",
      "Citrobacter_freundii",
      "Bacteroides_stercoris",
      "Lachnospiraceae_bacterium_1_4_56FAA",
      "Bacteroidales_bacterium_ph8",
      "Coprococcus_comes",
      "Olsenella_unclassified",
      "Streptococcus_gordonii",
      "Peptostreptococcaceae_noname_unclassified",
      "Dorea_longicatena",
      "Bacteroides_caccae",
      "Anaerotruncus_colihominis",
      "Ruminococcaceae_bacterium_D16",
      "Streptococcus_mitis_oralis_pneumoniae",
      "Anaerotruncus_unclassified",
      "Catenibacterium_mitsuokai",
      "Clostridiales_bacterium_1_7_47FAA",
      "Anaerostipes_unclassified",
      "Sutterella_wadsworthensis",
      "Eubacterium_brachy",
      "Fusobacterium_ulcerans",
      "Bacteroides_clarus",
      "Desulfovibrio_piger",
      "Streptococcus_sanguinis",
      "Phascolarctobacterium_succinatutens",
      "Streptococcus_australis",
      "Veillonella_atypica",
      "Peptostreptococcus_stomatis",
      "Solobacterium_moorei",
      "Bilophila_wadsworthia",
      "Streptococcus_cristatus",
      "Bacteroides_thetaiotaomicron",
      "Alistipes_onderdonkii",
      "Klebsiella_unclassified",
      "Anaerostipes_hadrus",
      "Bacteroides_eggerthii",
      "Blautia_producta",
      "Prevotella_copri",
      "Clostridium_citroniae",
      "Veillonella_unclassified",
      "Parabacteroides_distasonis",
      "Eubacterium_biforme",
      "Methanobrevibacter_smithii",
      "Oribacterium_sinus",
      "Coprococcus_catus",
      "Bifidobacterium_animalis",
      "Holdemania_unclassified",
      "Clostridium_ramosum",
      "Gordonibacter_pamelaeae",
      "Parvimonas_micra",
      "Roseburia_unclassified",
      "Anaerostipes_caccae",
      "Escherichia_coli",
      "Brachyspira_unclassified",
      "Butyricicoccus_pullicaecorum",
      "Bacteroides_intestinalis",
      "CRC",
    ],
    data: [
      [
        "10080",
        "0.00433",
        "0.00646",
        "0.0",
        "0.0",
        "7.6393",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "2.56008",
        "0.0",
        "0.0",
        "0.15803",
        "0.0",
        "0.00066",
        "0.0",
        "0.0",
        "0.00048",
        "0.0",
        "0.06529",
        "0.01537",
        "0.11356",
        "0.0",
        "0.0",
        "0.0",
        "0.00041",
        "0.07706",
        "0.0",
        "0.00439",
        "0.00068",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.01947",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.02187",
        "0.0",
        "0.00094",
        "0.00317",
        "0.26267",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.01451",
        "0.0",
        "0.01422",
        "1.75863",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.01546",
        "0.0",
        "0.0",
        "0.1073",
        "0.0",
        "0.0",
        "0.00261",
        "0.50441",
        "0.0",
        "0.06021",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "18.84838",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.00753",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.00237",
        "0.0",
        "0.0",
        "0.02548",
        "2.92889",
        "0.01711",
        "2.43416",
        "0.04746",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.79995",
        "1.86142",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.01866",
        "0.0",
        "0.0",
        "0.02006",
        "0.0",
        "0.0",
        "0.0",
        "0.02738",
        "0.0",
        "0.0",
        "1.64057",
        "0.0",
        "4.58097",
        "0.00035",
        "18.89684",
        "0.0",
        "0.68036",
        "0.0",
        "15.51713",
        "0.0",
        "0.01667",
        "0.0",
        "0.04901",
        "0.0",
        "0.0",
        "0.0",
        "0.00155",
        "0.00505",
        "0.00443",
        "3.96812",
        "0.0",
        "0.05105",
        "0.00386",
        "2.95908",
        "0.20198",
        "0.0",
        "0.00626",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.01003",
        "0.06398",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.02247",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.0",
        "0.17231",
        "0.0",
        "0.08481",
        "0.24043",
        "0.0",
        "0.02134",
        "0.0",
        "0.0",
        "0.01568",
        "0.511",
        "0.68992",
        "0.0",
        "0.0",
        "0.03854",
        "0.0",
        "0.0",
        "1.40945",
        "0.0025",
        "0.0",
        "0.0",
        "0.01695",
        "0.0",
        "2.36379",
        "0.0",
        "0.54644",
        "0.0",
        "0.00015",
        "0.0",
        "0.0",
        "3.43931",
        "0.0",
        "0.0",
        "0.0",
        "0",
      ],
    ],
  },
};

const payload = JSON.stringify(test_data);

export default function () {
  const res = http.post(
    `${inferenceBaseURL}/v1/explain/waterfall/${modelName}`,
    payload,
    {
      headers,
      timeout: "900s",
    }
  );
  if (res.status !== 200) {
    console.log('status', res.status)
    console.log('status', res)
  }
  check(res, {
    "explain status is 200": (r) => r.status === 200,
    "explain response has plot": (r) =>
      JSON.parse(r.body).explain?.[0]?.waterfall !== undefined,
  });

  sleep(1);
}
